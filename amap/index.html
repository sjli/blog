<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title></title>
    <link rel="stylesheet" href="//cache.amap.com/lbs/static/main1119.css"/>
    <style type="text/css">
        .amap-logo {
            display: none;
        }
        select {
            font-size: 100%;
        }
        #filters {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, .7);
            border-radius: 3px;
            padding: 10px;
        }
        #filters fieldset {
            border-width: 0;
        }
    </style>
    <script type="text/javascript" src="//webapi.amap.com/maps?v=1.3&key=3ee6a8e091927d8a1dc66e7205d996f3"></script>
    <script type="text/javascript" src="//cache.amap.com/lbs/static/addToolbar.js"></script>
    <script type="text/javascript" src="//code.jquery.com/jquery-2.2.4.min.js"></script>
</head>
<body>
<div id="container"></div>
<div id="filters">
    <fieldset>
        <label>类型筛选: </label>
        <select class="filter-type">
            <option>-请选择-</option>
            <option value="NRKA_BS" >NRKA_BS</option>
            <option value="NRKA_HSM" >NRKA_HSM</option>
            <option value="Mini" >Mini</option>
        </select>
    </fieldset>
    <fieldset>
        <label>区域筛选: </label>
        <select class="filter-region">
            <option>-请先选择类型-</option>
        </select>
    </fieldset>
</div>
<script type="text/javascript">
    var map = new AMap.Map("container", {
        resizeEnable: true
    });
    map.setCity('上海市');
    
    var infoWindow = new AMap.InfoWindow({
        offset: new AMap.Pixel(0, -30),
        closeWhenClickMap: true
    });

    var bindInfoClick = false;
    AMap.event.addListener(infoWindow, 'open', function(e) {
        if (bindInfoClick) {return;}
        bindInfoClick = true;
        setTimeout(function() {
            AMap.event.addDomListener(infoWindow.xa.cc, 'click', function(e) {
                var name = infoWindow.getContent();
                var pos = infoWindow.getPosition();
                var url = updateLink(name, pos.lat, pos.lng);
                location.href = url;
            })
        }, 100);
    });

    function updateLink(name, lat, lon) {
        var url;
        if(!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){
            //ios
            url = 'iosamap://viewMap?sourceApplication=applicationName&poiname='
                +name+'&lat='+lat+'&lon='+lon+'&dev=0';
        } else if (/windows|win32/i.test(navigator.userAgent)){
            //win
            url = 'http://m.amap.com/?q='+lat+','+lon+'&name='+name+'&dev=0';
        } else {
            //andorid
            url = 'androidamap://viewMap?sourceApplication=appname&poiname='+name+'&lat='+lat+'&lon='+lon+'&dev=0';
        }
        return url;
    }

    function setMarker(m, icon) {
        if (!m.accurate || !isNaN(m.SNAME)) {return;}
        var marker = new AMap.Marker({
            map: map,
            title: m.SNAME+', 地址: '+m.SPROVINCE+m.SDISTRICT+m.SSTREETNAME,
            icon: icon,
            position: [m.lon, m.lat],
            offset: new AMap.Pixel(-12, -36)
        });
        AMap.event.addListener(marker, 'click', function(e) {
            infoWindow.setContent(e.target.getTitle());
            infoWindow.open(map, e.target.getPosition());
        });
        return marker;
    }


    function _jsonpCallback(json) {
        var icons = {
            'NRKA_BS': 'images/mark_r.png',
            'NRKA_HSM': 'images/mark_g.png',
            'Mini': 'images/mark_b.png'
        };

        var type, region;

        function updateView() {
            if (!type) {return;}
            var data = json[type];
            if (region) {
                data = data.filter(function(v) {return v.SDISTRICT === region;});
            }
            map.clearMap();
            data.forEach(function(m) {
                setMarker(m, icons[type]);
            });
        }

        $('.filter-type').on('change', function() {
            var opts = this.selectedOptions;
            if (!opts[0].value) {
                return type = null;
            }
            type = opts[0].value;
            var regions = json[type].map(function(m){return m.SDISTRICT})
                .reduce(function(a,b){
                    if(a.indexOf(b) === -1){a.push(b)}
                    return a;
                },[]);
            var regionOpts = '<option>-请选择-</option>';
            regions.forEach(function(r) {
                regionOpts += '<option value="' + r + '">' + r + '</option>';
            });
            $('.filter-region').html(regionOpts);
            region = null;

            updateView();
            map.setFitView();
        });

        $('.filter-region').on('change', function() {
            var opts = this.selectedOptions;
            var data = json[type];
            if (opts[0].value) {
                region = opts[0].value;
            } else {
                region = null;
            }
            
            updateView();
        })

    }
</script>
<script type="text/javascript" src="data.js"></script>
</body>
</html>