<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title></title>
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>
    <style type="text/css">
        .amap-logo {
            display: none;
        }
    </style>
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=3ee6a8e091927d8a1dc66e7205d996f3"></script>
    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
</head>
<body>
<div id="container"></div>
<script type="text/javascript">
    var map = new AMap.Map("container", {
        resizeEnable: true
    });
    /*AMap.service(["AMap.PlaceSearch"], function() {
        var placeSearch = new AMap.PlaceSearch({ //构造地点查询类
            pageSize: 5,
            pageIndex: 1,
            city: "021", //城市
            map: map
        });
        //关键字查询
        placeSearch.search('宝洁');
    });*/
    var infoWindow = new AMap.InfoWindow({
        offset: new AMap.Pixel(0, -30),
        closeWhenClickMap: true
    });

    var bindInfoClick = false;
    AMap.event.addListener(infoWindow, 'open', function(e) {
        if (bindInfoClick) {return;}
        bindInfoClick = true;
        setTimeout(function() {
            AMap.event.addDomListener(infoWindow.xa.cc, 'click', function(e) {
                var name = infoWindow.getContent();
                var pos = infoWindow.getPosition();
                var url = updateLink(name, pos.lat, pos.lng);
                location.href = url;
            })
        }, 100);
    });

    function updateLink(name, lat, lon) {
        var url;
        if(!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){
            //ios
            url = 'iosamap://viewMap?sourceApplication=applicationName&poiname='
                +name+'&lat='+lat+'&lon='+lon+'&dev=0';
        } else if (/windows|win32/i.test(navigator.userAgent)){
            //win
            url = 'http://m.amap.com/?q='+lat+','+lon+'&name='+name+'&dev=0';
        } else {
            //andorid
            url = 'androidamap://viewMap?sourceApplication=appname&poiname='+name+'&lat='+lat+'&lon='+lon+'&dev=0';
        }
        return url;
    }

    

    function _jsonpCallback(json) {
        var icons = [
            'images/mark_r.png',
            'images/mark_g.png',
            'images/mark_b.png'
        ]
        function setMarker(marker, icon) {
            if (!marker.accurate || !isNaN(marker.SNAME)) {return;}
            var m = new AMap.Marker({
                map: map,
                title: marker.SNAME+', 地址: '+marker.SPROVINCE+marker.SDISTRICT+marker.SSTREETNAME,
                icon: icon,
                position: [marker.lon, marker.lat],
                offset: new AMap.Pixel(-12, -36)
            });
            AMap.event.addListener(m, 'click', function(e) {
                infoWindow.setContent(e.target.getTitle());
                infoWindow.open(map, e.target.getPosition());
            });
        }
        json.NRKA_BS.forEach(function(marker) {
            setMarker(marker, icons[0]);
        });
        json.NRKA_HSM.forEach(function(marker) {
            setMarker(marker, icons[1]);
        });
        json.Mini.forEach(function(marker) {
            setMarker(marker, icons[2]);
        });
        
        var newCenter = map.setFitView();
    }
</script>
<script type="text/javascript" src="data.js"></script>
</body>
</html>